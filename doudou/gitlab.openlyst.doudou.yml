app-id: gitlab.openlyst.doudou
runtime: org.freedesktop.Platform
runtime-version: '24.08'
sdk: org.freedesktop.Sdk
command: doudou

finish-args:
  # Audio (PipeWire systems use this via PulseAudio compatibility)
  - --socket=pulseaudio

  # Display
  - --socket=x11
  - --socket=wayland

  # Shared memory for graphics/audio buffers
  - --share=ipc

  # Network access (for streaming, APIs, etc.)
  - --share=network

  # GPU / hardware acceleration
  - --device=dri
  - --device=all

  # File system access
  - --filesystem=home
  - --filesystem=/media
  - --filesystem=/run/media
  - --filesystem=xdg-music:rw
  - --filesystem=xdg-videos:rw
  - --filesystem=xdg-download:rw

  # Environment for bundled libs
  - --env=LD_LIBRARY_PATH=/app/lib:/app/lib/ffmpeg
  - --env=PATH=/app/bin:/usr/bin:/usr/libexec:$PATH
  - --env=MPV_HOME=/app/share/mpv


modules:
  # ----------------------------------------------------------------------------
  # Essential audio/video dependencies
  # ----------------------------------------------------------------------------
  - name: nv-codec-headers
    cleanup:
      - '*'
    sources:
      - type: git
        url: https://git.videolan.org/git/ffmpeg/nv-codec-headers.git
        tag: n12.1.14.0
        commit: 1889e62e2d35ff7aa9baca2bceb14f053785e6f1
    no-autogen: true
    make-install-args:
      - PREFIX=/app
      
  # ----------------------------------------------------------------------------
  # libplacebo (required by mpv 0.40.0) - fetch with submodules so 3rdparty/glad is present
  # ----------------------------------------------------------------------------
  - name: libplacebo
    buildsystem: meson
    sources:
      - type: git
        url: https://github.com/haasn/libplacebo.git
        tag: v6.338.2
        # flatpak-builder might warn about 'submodules', but in practice fetching them is necessary:
        submodules: true
    config-opts:
      - -Ddefault_library=shared

  # ----------------------------------------------------------------------------
  # libass (subtitle renderer) - build with autotools (release uses autoconf)
  # ----------------------------------------------------------------------------
  - name: libass
    buildsystem: autotools
    sources:
      - type: git
        url: https://github.com/libass/libass.git
        tag: 0.17.1
    # autotools module will run autogen/configure automatically; no meson flags here

  # ----------------------------------------------------------------------------
  # mpv (both library and binary - your app might need the mpv command)
  # ----------------------------------------------------------------------------
  - name: mpv
    buildsystem: meson
    sources:
      - type: archive
        url: https://github.com/mpv-player/mpv/archive/refs/tags/v0.40.0.zip
        sha256: 00fbe63728f7d06b351b2ab532db77ccdba0a49d45f88c456e7f54207457ef59
    config-opts:
      - -Dlibmpv=true
      - -Dcplayer=true  # Build the mpv binary
      - -Dmanpage-build=disabled
      - -Dhtml-build=disabled
      - -Dalsa=enabled
      - -Dpulse=enabled
    post-install:
      - install -Dm644 /app/etc/mpv/encoding-profiles.conf /app/etc/mpv/encoding-profiles.conf || true

  # ----------------------------------------------------------------------------
  # ffmpeg-extension directory for the FFmpeg extension
  # ----------------------------------------------------------------------------
  - name: ffmpeg-extension
    buildsystem: simple
    build-commands:
      - mkdir -p /app/lib/ffmpeg

  # ----------------------------------------------------------------------------
  # doudou app (your main prebuilt bundle)
  # ----------------------------------------------------------------------------
  - name: doudou
    buildsystem: simple
    build-commands:
      - unzip -q doudou-release.zip
      - mkdir -p /app/bin
      - mkdir -p /app/lib/doudou
      - cp -r build/linux/x64/release/bundle/* /app/lib/doudou/
      - install -Dm755 doudou /app/bin/doudou
      - install -Dm644 gitlab.openlyst.doudou.desktop /app/share/applications/gitlab.openlyst.doudou.desktop
      - install -Dm644 gitlab.openlyst.doudou-64.png /app/share/icons/hicolor/64x64/apps/gitlab.openlyst.doudou.png
      - install -Dm644 gitlab.openlyst.doudou.metainfo.xml /app/share/metainfo/gitlab.openlyst.doudou.metainfo.xml
    sources:
      - type: file
        url: https://gitlab.com/Openlyst/doudou/-/jobs/artifacts/5e14e4bf97b4f89a1499e46d7f06073dcd82885f/download?job=build_release_linux
        sha256: 7d3db6ed612909c988fa02492b2550cfbb642f8d924780fb0dcc6565cc42344f
        dest-filename: doudou-release.zip
      - type: script
        dest-filename: doudou
        commands:
          - '#!/bin/bash'
          - 'export PATH="/app/bin:$PATH"'
          - 'export LD_LIBRARY_PATH="/app/lib:/app/lib/ffmpeg:$LD_LIBRARY_PATH"'
          - 'export MPV_HOME="/app/share/mpv"'
          - 'exec /app/lib/doudou/doudou "$@"'
      - type: file
        path: gitlab.openlyst.doudou.desktop
      - type: file
        path: gitlab.openlyst.doudou-64.png
      - type: file
        path: gitlab.openlyst.doudou.metainfo.xml

add-extensions:
  org.freedesktop.Platform.ffmpeg-full:
    directory: lib/ffmpeg
    version: '24.08'
    add-ld-path: .
