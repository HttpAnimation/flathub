id: gitlab.openlyst.doudou
runtime: org.freedesktop.Platform
runtime-version: '24.08'
sdk: org.freedesktop.Sdk
command: doudou
finish-args:
  - --share=network
  - --socket=wayland
  - --socket=x11
  - --share=ipc
  - --socket=pulseaudio
  - --filesystem=xdg-music:ro
  - --filesystem=xdg-download
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.freedesktop.secrets
  - --device=dri
  - --filesystem=host:ro

modules:
  - name: doudou
    buildsystem: simple
    build-commands:
      - mv download artifacts.zip
      - unzip -q artifacts.zip
      # Install the entire Flutter bundle to /app/lib/doudou preserving the structure
      - install -d /app/lib/doudou
      - cp -a build/linux/x64/release/bundle/* /app/lib/doudou/
      # Create wrapper script that runs from the correct directory
      - install -d /app/bin
      - |
        cat > /app/bin/doudou << 'EOF'
        #!/bin/sh
        cd /app/lib/doudou
        exec ./doudou "$@"
        EOF
      - chmod +x /app/bin/doudou
      - install -Dm644 gitlab.openlyst.doudou.desktop /app/share/applications/gitlab.openlyst.doudou.desktop
      - install -Dm644 gitlab.openlyst.doudou.metainfo.xml /app/share/metainfo/gitlab.openlyst.doudou.metainfo.xml
      - install -Dm644 gitlab.openlyst.doudou-64.png /app/share/icons/hicolor/64x64/apps/gitlab.openlyst.doudou.png
    sources:
      - type: file
        url: https://gitlab.com/Openlyst/doudou/-/jobs/artifacts/c392f5d1da3d5636b945b6d14637d80d1217476c/download?job=build_release_linux
        sha256: dd90557598c012bf37930306849b52a12e7d401ba754df33f078807823211af1
        dest-filename: download
      - type: file
        path: gitlab.openlyst.doudou.desktop
      - type: file
        path: gitlab.openlyst.doudou.metainfo.xml
      - type: file
        path: gitlab.openlyst.doudou-64.png
