app-id: gitlab.openlyst.doudou
runtime: org.freedesktop.Platform
runtime-version: '24.08'
sdk: org.freedesktop.Sdk
command: doudou

finish-args:
  # X11 + XShm access
  - --share=ipc
  - --socket=x11
  # Wayland access
  - --socket=wayland
  # Audio output
  - --socket=pulseaudio
  # Network access (for streaming)
  - --share=network
  # OpenGL access
  - --device=dri
  # Access to home directory for media files
  - --filesystem=home
  # Access to removable media
  - --filesystem=/media
  - --filesystem=/run/media

modules:
  # Create directory for ffmpeg extension
  - name: ffmpeg-extension
    buildsystem: simple
    build-commands:
      - mkdir -p /app/lib/ffmpeg

  # Main doudou application
  - name: doudou
    buildsystem: simple
    build-commands:
      # Extract the downloaded zip
      - unzip -q doudou-release.zip
      # Install the application files
      - mkdir -p /app/bin
      - mkdir -p /app/lib/doudou
      - cp -r build/linux/x64/release/bundle/* /app/lib/doudou/
      # Create wrapper script to launch the app
      - install -Dm755 doudou /app/bin/doudou
      # Install desktop file
      - install -Dm644 gitlab.openlyst.doudou.desktop /app/share/applications/gitlab.openlyst.doudou.desktop
      # Install icon
      - install -Dm644 gitlab.openlyst.doudou-64.png /app/share/icons/hicolor/64x64/apps/gitlab.openlyst.doudou.png
      # Install metainfo
      - install -Dm644 gitlab.openlyst.doudou.metainfo.xml /app/share/metainfo/gitlab.openlyst.doudou.metainfo.xml
    sources:
      # Download the pre-built release
      - type: file
        url: https://gitlab.com/Openlyst/doudou/-/jobs/artifacts/c392f5d1da3d5636b945b6d14637d80d1217476c/download?job=build_release_linux
        sha256: 5ce7e80f8fd7d7a060ba445e78ebe037261abe80a60e0413f4f3cc411fbeff14
        dest-filename: doudou-release.zip
      
      # Wrapper script to launch the application
      - type: script
        dest-filename: doudou
        commands:
          - exec /app/lib/doudou/doudou "$@"
      
      # Desktop file
      - type: file
        path: gitlab.openlyst.doudou.desktop
      
      # Icon
      - type: file
        path: gitlab.openlyst.doudou-64.png
      
      # Metainfo
      - type: file
        path: gitlab.openlyst.doudou.metainfo.xml

add-extensions:
  org.freedesktop.Platform.ffmpeg-full:
    directory: lib/ffmpeg
    version: '24.08'
    add-ld-path: .
    no-autodownload: false
