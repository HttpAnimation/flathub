app-id: gitlab.openlyst.doudou
runtime: org.freedesktop.Platform
runtime-version: '24.08'
sdk: org.freedesktop.Sdk
command: doudou

finish-args:
  - --share=ipc
  - --socket=x11
  - --socket=wayland
  - --socket=pulseaudio
  - --share=network
  - --device=dri
  - --filesystem=home
  - --filesystem=/media
  - --filesystem=/run/media

modules:
  # ----------------------------------------------------------------------------
  # libplacebo (required by mpv 0.40.0) - fetch with submodules so 3rdparty/glad is present
  # ----------------------------------------------------------------------------
  - name: libplacebo
    buildsystem: meson
    sources:
      - type: git
        url: https://github.com/haasn/libplacebo.git
        tag: v6.338.2
        # flatpak-builder might warn about 'submodules', but in practice fetching them is necessary:
        submodules: true
    config-opts:
      - -Ddefault_library=shared

  # ----------------------------------------------------------------------------
  # libass (subtitle renderer) - build with autotools (release uses autoconf)
  # ----------------------------------------------------------------------------
  - name: libass
    buildsystem: autotools
    sources:
      - type: git
        url: https://github.com/libass/libass.git
        tag: 0.17.1
    # autotools module will run autogen/configure automatically; no meson flags here

  # ----------------------------------------------------------------------------
  # libmpv (mpv core library used by your app)
  # ----------------------------------------------------------------------------
  - name: libmpv
    buildsystem: meson
    sources:
      - type: archive
        url: https://github.com/mpv-player/mpv/archive/refs/tags/v0.40.0.zip
        sha256: 00fbe63728f7d06b351b2ab532db77ccdba0a49d45f88c456e7f54207457ef59
    config-opts:
      - -Dlibmpv=true
      # DO NOT pass -Dlibass or -Dlibass=false â€” mpv's meson autodetects libass,
      # and passing invalid -D keys causes the "Unknown options" error.

  # ----------------------------------------------------------------------------
  # ffmpeg-extension placeholder directory (keeps your previous manifest intent)
  # ----------------------------------------------------------------------------
  - name: ffmpeg-extension
    buildsystem: simple
    build-commands:
      - mkdir -p /app/lib/ffmpeg

  # ----------------------------------------------------------------------------
  # doudou app (your main prebuilt bundle)
  # ----------------------------------------------------------------------------
  - name: doudou
    buildsystem: simple
    build-commands:
      - unzip -q doudou-release.zip
      - mkdir -p /app/bin
      - mkdir -p /app/lib/doudou
      - cp -r build/linux/x64/release/bundle/* /app/lib/doudou/
      - install -Dm755 doudou /app/bin/doudou
      - install -Dm644 gitlab.openlyst.doudou.desktop /app/share/applications/gitlab.openlyst.doudou.desktop
      - install -Dm644 gitlab.openlyst.doudou-64.png /app/share/icons/hicolor/64x64/apps/gitlab.openlyst.doudou.png
      - install -Dm644 gitlab.openlyst.doudou.metainfo.xml /app/share/metainfo/gitlab.openlyst.doudou.metainfo.xml
    sources:
      - type: file
        url: https://gitlab.com/Openlyst/doudou/-/jobs/artifacts/cc9539193c0b68e9ed28965a4d57eb2ab71c4efb/download?job=build_release_linux
        sha256: 8fb6e19cd9c0bebd9d844382eb2b9f384acbe71d369614540a366ef874a20803
        dest-filename: doudou-release.zip
      - type: script
        dest-filename: doudou
        commands:
          - exec /app/lib/doudou/doudou "$@"
      - type: file
        path: gitlab.openlyst.doudou.desktop
      - type: file
        path: gitlab.openlyst.doudou-64.png
      - type: file
        path: gitlab.openlyst.doudou.metainfo.xml

add-extensions:
  org.freedesktop.Platform.ffmpeg-full:
    directory: lib/ffmpeg
    version: '24.08'
    add-ld-path: .
    no-autodownload: false
